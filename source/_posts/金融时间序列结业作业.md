title: 金融时间序列结业作业
date: 2014-12-28 13:55:36
author: 赵空暖
tags:
- R
- 数据分析
categories:
- R
- 数据分析
---
#结业测试大作业#
>内容：使用在课程中学过的各种时间序列模型为某实际场景建模，并且诠释你的结果的意义。 
要求： 
1.要解决的问题有意义，业务背景要有详细的介绍与解释
2.数据真实，标明数据来源，可以使用参考书的数据，但不得与书上的例子一致，即可以使用书上的数据构建新的模型（注：新的模型是指另一个种类的模型，如AR（1）与AR（3）看做同一个模型）
3.数学建模和数学工具运用正确及有效，要求对同一数据尝试2种或以上的时间序列模型，或采用2种或以上的不同参数估计方法
4.使用R其它各种工具进行实际计算验证，程序和结果正确 
5.对模型结果要结合业务背景进行详细解释，不得只有代码结果而没有相应解释 

问题意义以及数据来源移步[之前自己写的这篇文章](http://www.zhaokongnuan.com/2014/12/28/%E6%BD%8D%E5%9D%8A%E7%89%A9%E4%BB%B7%E4%BF%A1%E6%81%AF%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%8F%8A%E5%B1%95%E7%8E%B0/)
这是在炼数成金上学完rapidminer这门课假期里完成的，那么这次作业要求对同一数据尝试两种以上的时间序列模型或两种以上的不同参数估计方法，所以还是用这里面抓取的数据，尝试使用R进行实际计算验证。
###环境准备：###
win7 64bit
R version 3.1.1 (2014-07-10)
mysqk Server version: 5.5.20-log MySQL Community Server (GPL)
##通过ODBC进行R和mysql的连接##
```r
>install.packages("RODBC")
trying URL 'http://cran.rstudio.com/bin/windows/contrib/3.1/RODBC_1.3-10.zip'
Content type 'application/zip' length 828501 bytes (809 Kb)
opened URL
downloaded 809 Kb

package ‘RODBC’ successfully unpacked and MD5 sums checked

The downloaded binary packages are in
	C:\Users\Administrator\AppData\Local\Temp\Rtmp2H55eL\downloaded_packages
>library(RODBC)
>channel <- odbcConnect("rmysql", uid="root", pwd="");
>sqlTables(channel)#查看数据中的表
   TABLE_CAT TABLE_SCHEM   TABLE_NAME TABLE_TYPE REMARKS
1       test                  foodcpi      TABLE        
2       test                  from_to      TABLE        
3       test                globalcpi      TABLE        
4       test                    goods      TABLE        
5       test                 monthcpi      TABLE        
6       test                    place      TABLE        
7       test                  pre_cab      TABLE        
8       test                    price      TABLE        
9       test             reservations      TABLE        
10      test                   sheet9      TABLE        
11      test               userdetail      TABLE        
12      test               yujingdata      TABLE        
13      test                      zkn      TABLE 
>data<-sqlFetch(channel,"foodcpi")# 查看表的内容，存到数据框里
>head(data)
        日期 食品类 粮食类 肉禽及其制品类  蛋类 水产品类 鲜菜类 鲜果类
1 2014-06-01  103.7  103.2          101.9 113.1    104.0   98.2  119.8
2 2014-05-01  104.1  103.0          103.2 117.6    105.0   97.5  120.0
3 2014-04-01  102.3  102.8           99.3 107.0    105.7   92.1  118.6
4 2014-03-01  104.1  102.7           98.2 100.4    107.7  112.9  117.3
5 2014-02-01  102.7  102.8           97.0  94.2    104.7  103.3  119.7
6 2014-01-01  103.7  103.1          100.3  96.2    106.3  102.1  123.0
```
需要载入的包
```r
install_github('recharts','taiyun')
require(devtools)
require(recharts)
require(plyr)
require(ggplot2)
```
用recharts画一个简单的关于CPI八大类月度价格图,使用recharts是因为其交互性强，以下展示均可和用户交互。
```r
attach(data)
time <-as.Date(日期,"%Y/%m/%d")
rownames(data)<-time
pic<-eBar(data[,-1],size = c(1040,488),title = '价格走势图',opt=list(dataZoom=list(show=TRUE,end=35)),legend.orient="vertical")
plot(eBar(data[,-1],size = c(1040,488),title = '价格走势图',opt=list(dataZoom=list(show=TRUE,end=35)),legend.orient="vertical"))
print(pic)
``` 
（如加载缓慢请重新刷新该页面）
<script src='http://echarts.baidu.com/doc/example/www/js/echarts.js'></script>
<div id='eBarID197041c54b97' style='width:100%; height:450px;border:1px solid #ccc;padding:5px;'></div>
<script>

   require.config({
        paths:{ 
            'echarts': 'http://echarts.baidu.com/build/dist'
        }
    });
    
    // Step:4 require echarts and use it in the callback.
    require(
        [
            'echarts',
            'echarts/chart/bar',
            'echarts/chart/line',
            'echarts/chart/scatter',
            'echarts/chart/k',
            'echarts/chart/pie',
            'echarts/chart/map',
            'echarts/chart/force',
            'echarts/chart/radar'
        ],
	function(ec) {
		var EChart_eBarID197041c54b97 = ec.init(document.getElementById('eBarID197041c54b97'))
		var option_eBarID197041c54b97 = 
{
	"dataZoom" : {
		"show" : true,
		"end" : 35
	},
	"title" : {
		"text" :  "价格走势图",
		"subtext" : "",
		"x" : "center",
		"y" : "top"
	},
	"calculable" : true,
	"tooltip" : {
		"show" : true,
		"trigger" : "item"
	},
	"toolbox" : {
		"show" : true,
		"x" : "right",
		"y" : "top",
		"orient" : "horizontal",
		"feature" : {
			"mark" : {
				"show" : true
			},
			"dataZoom" : {
				"show" : false
			},
			"magicType" : {
				"show" : true,
				"type" : [
					"line",
					"bar",
					"stack",
					"tiled"
				]
			},
			"restore" : {
				"show" : true
			},
			"dataView" : {
				"show" : {
					"readOnly" : false
				}
			},
			"saveAsImage" : {
				"show" : true
			}
		}
	},
	"legend" : {
		"show" : true,
		"orient" : "vertical",
		"x" : "left",
		"y" : "top",
		"data" : [
			"食品类",
			"粮食类",
			"肉禽及其制品类",
			"蛋类",
			"水产品类",
			"鲜菜类",
			"鲜果类"
		]
	},
	"xAxis" : {
		"position" : "bottom",
		"name" : "",
		"nameLocation" : "start",
		"scale" : true,
		"precision" : 2,
		"power" : 2,
		"axisLine" : {
			"show" : true
		},
		"axisTick" : {
			"show" : false
		},
		"axisLable" : {
			"show" : true,
			"textStyle" : {
				"color" : "black"
			}
		},
		"splitLine" : {
			"show" : true
		},
		"splitArea" : {
			"show" : false
		},
		"type" : "category",
		"data" : [
			"2014-06-01",
			"2014-05-01",
			"2014-04-01",
			"2014-03-01",
			"2014-02-01",
			"2014-01-01",
			"2013-12-01",
			"2013-11-01",
			"2013-10-01",
			"2013-09-01",
			"2013-08-01",
			"2013-07-01",
			"2013-06-01",
			"2013-05-01",
			"2013-04-01",
			"2013-02-01",
			"2013-01-01",
			"2014-07-01"
		],
		"boundaryGap" : true
	},
	"yAxis" : {
		"position" : "left",
		"name" : "",
		"nameLocation" : "start",
		"scale" : true,
		"precision" : 2,
		"power" : 2,
		"axisLine" : {
			"show" : true
		},
		"axisTick" : {
			"show" : false
		},
		"axisLable" : {
			"show" : true
		},
		"splitLine" : {
			"show" : true
		},
		"splitArea" : {
			"show" : false
		},
		"type" : "value",
		"boundaryGap" : [
			0,
			0
		]
	},
	"series" : [
		{
			"type" : "bar",
			"name" : "食品类",
			"data" : [
				103.7,
				104.1,
				102.3,
				104.1,
				102.7,
				103.7,
				104.1,
				105.9,
				106.5,
				106.1,
				104.7,
				105,
				104.9,
				103.7,
				104.1,
				102.3,
				104.1,
				102.7
			]
		},
		{
			"type" : "bar",
			"name" : "粮食类",
			"data" : [
				103.2,
				103,
				102.8,
				102.7,
				102.8,
				103.1,
				103.8,
				104,
				103.8,
				104,
				104.7,
				105.1,
				105.1,
				103.2,
				103,
				102.8,
				102.7,
				102.8
			]
		},
		{
			"type" : "bar",
			"name" : "肉禽及其制品类",
			"data" : [
				101.9,
				103.2,
				99.3,
				98.2,
				97,
				100.3,
				103.6,
				105.5,
				105.8,
				106.6,
				107.2,
				105.9,
				104.8,
				101.9,
				103.2,
				99.3,
				98.2,
				97
			]
		},
		{
			"type" : "bar",
			"name" : "蛋类",
			"data" : [
				113.1,
				117.6,
				107,
				100.4,
				94.2,
				96.2,
				95.9,
				98.3,
				99.3,
				101.3,
				100.3,
				101.3,
				100.3,
				113.1,
				117.6,
				107,
				100.4,
				94.2
			]
		},
		{
			"type" : "bar",
			"name" : "水产品类",
			"data" : [
				104,
				105,
				105.7,
				107.7,
				104.7,
				106.3,
				105.5,
				106.5,
				106.4,
				105.9,
				104.3,
				103.1,
				103.1,
				104,
				105,
				105.7,
				107.7,
				104.7
			]
		},
		{
			"type" : "bar",
			"name" : "鲜菜类",
			"data" : [
				98.2,
				97.5,
				92.1,
				112.9,
				103.3,
				102.1,
				102.6,
				122.3,
				131.5,
				118.9,
				105.2,
				111.8,
				109.7,
				98.2,
				97.5,
				92.1,
				112.9,
				103.3
			]
		},
		{
			"type" : "bar",
			"name" : "鲜果类",
			"data" : [
				119.8,
				120,
				118.6,
				117.3,
				119.7,
				123,
				115.6,
				110.6,
				108.8,
				112.5,
				107.5,
				107.3,
				111.4,
				119.8,
				120,
				118.6,
				117.3,
				119.7
			]
		}
	]
}
  EChart_eBarID197041c54b97.setOption(option_eBarID197041c54b97);
        }
    );
</script>

现在还是以大白菜的价格为例
```r
>cabb<-odbcConnectExcel("C:\\Users\\Administrator\\Desktop\\test.xls")
>cabbiage<-sqlFetch(cabb,"Data")
>close(cabb)
>cabb2<-data.frame(cabbiage$本期价格)
>rownames(cabb2) <- cabbiage$采价日期
>head(cabb2)
           cabbiage.本期价格
2013-11-19              0.49
2013-11-20              0.49
2013-11-21              0.59
2013-11-22              0.48
2013-11-25              0.59
2013-11-26              0.59
>pic2<-eLine(cabb2,size = c(1040,488),title = '大白菜价格走势图',opt=list(dataZoom=list(show=TRUE,end=35)),legend.orient="vertical")
>plot(pic2)
>print(pic2)
```

<!-- divChart -->
<div id='eLineID197051fc438e' style='width:100%; height:450px ;border:1px solid #ccc;padding:10px;'></div>

<!-- jsChart -->
<script>

   require.config({
        paths:{ 
            'echarts': 'http://echarts.baidu.com/build/dist'
        }
    });
    
    // Step:4 require echarts and use it in the callback.
    require(
        [
            'echarts',
            'echarts/chart/bar',
            'echarts/chart/line',
            'echarts/chart/scatter',
            'echarts/chart/k',
            'echarts/chart/pie',
            'echarts/chart/map',
            'echarts/chart/force',
            'echarts/chart/radar'
        ],
	function(ec) {
		var EChart_eLineID197051fc438e = ec.init(document.getElementById('eLineID197051fc438e'))
		var option_eLineID197051fc438e = 
{
	"dataZoom" : {
		"show" : true,
		"end" : 35
	},
	"title" : {
		"text" : "大白菜价格走势图",
		"subtext" : "",
		"x" : "center",
		"y" : "top"
	},
	"calculable" : true,
	"tooltip" : {
		"show" : true,
		"trigger" : "item"
	},
	"toolbox" : {
		"show" : true,
		"x" : "right",
		"y" : "top",
		"orient" : "horizontal",
		"feature" : {
			"mark" : {
				"show" : true
			},
			"dataZoom" : {
				"show" : false
			},
			"magicType" : {
				"show" : true,
				"type" : [
					"line",
					"bar",
					"stack",
					"tiled"
				]
			},
			"restore" : {
				"show" : true
			},
			"dataView" : {
				"show" : {
					"readOnly" : false
				}
			},
			"saveAsImage" : {
				"show" : true
			}
		}
	},
	"legend" : {
		"show" : true,
		"orient" : "vertical",
		"x" : "left",
		"y" : "top",
		"data" : [
			"cabbiage.本期价格"
		]
	},
	"xAxis" : {
		"position" : "bottom",
		"name" : "",
		"nameLocation" : "start",
		"scale" : true,
		"precision" : 2,
		"power" : 2,
		"axisLine" : {
			"show" : true
		},
		"axisTick" : {
			"show" : false
		},
		"axisLable" : {
			"show" : true,
			"textStyle" : {
				"color" : "black"
			}
		},
		"splitLine" : {
			"show" : true
		},
		"splitArea" : {
			"show" : false
		},
		"type" : "category",
		"data" : [
			"2013-11-19",
			"2013-11-20",
			"2013-11-21",
			"2013-11-22",
			"2013-11-25",
			"2013-11-26",
			"2013-11-27",
			"2013-11-28",
			"2013-11-29",
			"2013-12-02",
			"2013-12-03",
			"2013-12-04",
			"2013-12-06",
			"2013-12-09",
			"2013-12-10",
			"2013-12-11",
			"2013-12-12",
			"2013-12-13",
			"2013-12-16",
			"2013-12-17",
			"2013-12-18",
			"2013-12-19",
			"2013-12-20",
			"2013-12-23",
			"2013-12-24",
			"2013-12-25",
			"2013-12-26",
			"2013-12-27",
			"2013-12-30",
			"2013-12-31",
			"2014-01-02",
			"2014-01-03",
			"2014-01-06",
			"2014-01-07",
			"2014-01-08",
			"2014-01-09",
			"2014-01-10",
			"2014-01-13",
			"2014-01-14",
			"2014-01-15",
			"2014-01-16",
			"2014-01-17",
			"2014-01-20",
			"2014-01-21",
			"2014-01-22",
			"2014-01-23",
			"2014-01-24",
			"2014-01-26",
			"2014-01-27",
			"2014-01-28",
			"2014-01-29",
			"2014-01-30",
			"2014-02-07",
			"2014-02-08",
			"2014-02-10",
			"2014-02-11",
			"2014-02-12",
			"2014-02-13",
			"2014-02-14",
			"2014-02-17",
			"2014-02-18",
			"2014-02-19",
			"2014-02-20",
			"2014-02-21",
			"2014-02-24",
			"2014-02-25",
			"2014-02-26",
			"2014-02-27",
			"2014-02-28",
			"2014-03-03",
			"2014-03-04",
			"2014-03-05",
			"2014-03-06",
			"2014-03-07",
			"2014-03-10",
			"2014-03-11",
			"2014-03-12",
			"2014-03-13",
			"2014-03-14",
			"2014-03-17",
			"2014-03-18",
			"2014-03-19",
			"2014-03-20",
			"2014-03-21",
			"2014-03-24",
			"2014-03-25",
			"2014-03-26",
			"2014-03-27",
			"2014-03-28",
			"2014-03-31",
			"2014-04-01",
			"2014-04-02",
			"2014-04-03",
			"2014-04-04",
			"2014-04-08",
			"2014-04-09",
			"2014-04-10",
			"2014-04-11",
			"2014-04-14",
			"2014-04-15",
			"2014-04-16",
			"2014-04-17",
			"2014-04-18",
			"2014-04-21",
			"2014-04-22",
			"2014-04-23",
			"2014-04-24",
			"2014-04-25",
			"2014-04-28",
			"2014-04-29",
			"2014-04-30",
			"2014-05-04",
			"2014-05-05",
			"2014-05-06",
			"2014-05-07",
			"2014-05-08",
			"2014-05-09",
			"2014-05-12",
			"2014-05-13",
			"2014-05-14",
			"2014-05-15",
			"2014-05-16",
			"2014-05-19",
			"2014-05-20",
			"2014-05-21",
			"2014-05-22",
			"2014-05-23",
			"2014-05-26",
			"2014-05-27",
			"2014-05-28",
			"2014-05-29",
			"2014-05-30",
			"2014-06-03",
			"2014-06-04",
			"2014-06-05",
			"2014-06-06",
			"2014-06-09",
			"2014-06-10",
			"2014-06-11",
			"2014-06-12",
			"2014-06-13",
			"2014-06-16",
			"2014-06-17",
			"2014-06-18",
			"2014-06-19",
			"2014-06-20",
			"2014-06-23",
			"2014-06-24",
			"2014-06-25",
			"2014-06-26",
			"2014-06-27",
			"2014-06-30",
			"2014-07-01",
			"2014-07-02",
			"2014-07-03",
			"2014-07-04",
			"2014-07-07",
			"2014-07-08",
			"2014-07-09",
			"2014-07-10",
			"2014-07-11",
			"2014-07-14",
			"2014-07-15",
			"2014-07-16",
			"2014-07-17",
			"2014-07-18",
			"2014-07-21",
			"2014-07-22",
			"2014-07-23",
			"2014-07-24",
			"2014-07-25",
			"2014-07-28",
			"2014-07-29",
			"2014-07-30"
		],
		"boundaryGap" : true
	},
	"yAxis" : {
		"position" : "left",
		"name" : "",
		"nameLocation" : "start",
		"scale" : true,
		"precision" : 2,
		"power" : 2,
		"axisLine" : {
			"show" : true
		},
		"axisTick" : {
			"show" : false
		},
		"axisLable" : {
			"show" : true
		},
		"splitLine" : {
			"show" : true
		},
		"splitArea" : {
			"show" : false
		},
		"type" : "value",
		"boundaryGap" : [
			0,
			0
		]
	},
	"series" : [
		{
			"type" : "line",
			"name" : "cabbiage.鏈湡浠锋牸",
			"data" : [
				0.49,
				0.49,
				0.59,
				0.48,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.68,
				0.68,
				0.68,
				0.68,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.38,
				0.38,
				0.38,
				0.38,
				0.39,
				0.39,
				0.39,
				0.39,
				0.48,
				0.48,
				0.48,
				0.58,
				0.58,
				0.58,
				0.58,
				0.58,
				0.29,
				0.58,
				0.58,
				0.58,
				0.38,
				0.58,
				0.58,
				0.58,
				0.58,
				0.58,
				0.58,
				0.58,
				0.58,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				0.59,
				1.38,
				1.38,
				1.19,
				1.19,
				1.19,
				1.19,
				1.19,
				1.19,
				1.19,
				0.99,
				0.78,
				0.78,
				0.78,
				0.78,
				0.55,
				0.55,
				0.58,
				0.68,
				0.68,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.48,
				0.68,
				0.68,
				0.39,
				0.39,
				0.88,
				0.88,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.68,
				0.88,
				0.88,
				1.25,
				1.25,
				1.25,
				1.25,
				1.25,
				1.25,
				1.25,
				1.25,
				0.79,
				0.99,
				0.99,
				0.99,
				0.99,
				1.18,
				1.18,
				0.99,
				0.99,
				0.99,
				0.99,
				0.99,
				0.99,
				0.99,
				0.99,
				1.25,
				1.25,
				1.25
			]
		}
	]
}
  EChart_eLineID197051fc438e.setOption(option_eLineID197051fc438e);
        }
    );
</script>

使用R来分析预测大白菜数据
一、使用线性拟合
```r
>cabb_lm<- lm(cabbiage[,1]~cabbiage[,2])
>summary(cabb_lm)

Call:
lm(formula = cabbiage[, 1] ~ cabbiage[, 2])

Residuals:
     Min       1Q   Median       3Q      Max 
-0.41869 -0.14042  0.00618  0.06052  0.67017 

Coefficients:
                Estimate Std. Error t value Pr(>|t|)    
(Intercept)   -3.123e+01  3.314e+00  -9.424   <2e-16 ***
cabbiage[, 2]  2.288e-08  2.374e-09   9.639   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 0.2002 on 172 degrees of freedom
Multiple R-squared:  0.3507,	Adjusted R-squared:  0.3469 
F-statistic:  92.9 on 1 and 172 DF,  p-value: < 2.2e-16
>plot(cabbiage$采价日期,cabbiage$本期价格,type="o")
>abline(cabb_lm)
#检验残差值是否为白噪声
>Box.test(residuals(cabb_lm))
Box-Pierce test

data:  residuals(cabb_lm)
X-squared = 121.2962, df = 1, p-value < 2.2e-16
#可见不是白噪声
```
![line](/image/line.png)
二、ARIMA模型
```r
> time1 <- as.Date(cabbiage$采价日期)
> class(time1)
[1] "Date"
> data1 <- cabbiage$本期价格
> cabb_zoo <- zoo(data1,time1)
> plot(cabb_zoo)
```
![home1](/image/home1.png)
```r
> #不知道怎么转成合适的ts
> cabb_ts <-ts(data = data1, start =1, frequency = 1)
> ts.plot(cabb_ts)
```
![home2](/image/home2.png)
```r
> #查看自相关图
> acf(cabb_ts)
```
![home5](/image/home5.png)
```r
> #查看偏相关图
> pacf(cabb_ts)
```
![home6](/image/home6.png)
```r
> #可能有季节性，用MA来拟合
> #趋势通过差分来消除
> #季节性因素，确定相应的period
> cabb.fit <- arima(cabb_ts,order=c(0,1,1), seasonal=list(order=c(0,1,1), period=12))
> cabb.fit
Series: cabb_ts 
ARIMA(0,1,1)(0,1,1)[12]                    

Coefficients:
          ma1     sma1
      -0.1694  -1.0000
s.e.   0.0935   0.0863

sigma^2 estimated as 0.0121:  log likelihood=110.93
AIC=-215.85   AICc=-215.7   BIC=-206.61
> #对结果进行诊断
> tsdiag(cabb.fit)
```
![home0](/image/home0.png)
```r
> #加载时间序列包
> library(forecast)
> #向前预测12期，默认情况下24期
> cabb.forecast <- forecast(cabb.fit,12)
> plot.forecast(cabb.forecast)
```
![home3](/image/home3.png)

----不知道咋回事，嵌入js之后就评论框就不见了%>_<%----