title: 掀起你的盖头来--磁盘我来看看你
date: 2015-04-12 14:17:07
author: 赵空暖
tags: 性能测试
categories: 性能测试
---
![disk_title](/image/disk_title.jpg)
#课堂笔记#
##目的##
了解并熟悉磁盘的基本结构和运行原理，进而提升对整个计算机体系的进一步理解。
##认识磁盘##
![disk_look](/image/disk_look.jpg)
> 嗨，兄弟，你太慢了！
![disk_speed2](/image/disk_speed2.png)
> 这能全怪我吗？磁盘抱怨说。

那这是为什么呢
* 数字时代中的机械运行
* 基于成本和现实的考虑 - -目前机械磁盘使用仍然非常普遍。
![disk_speed](/image/disk_speed.png)

##磁盘表示和存储数据##
* 磁盘如何表示和存储数据 ？
磁头磁化盘面用有磁和无磁来磁化盘面，表示0和1
* 一块新的磁盘上面有数据吗？
有的。因为盘面上磁的状态只有两种，有磁或者没有。
* 500G的磁盘有多大？
硬件厂商在生产时是按1MB=1000KB来算的,这样生产出来的500G实际容量为500*1000*1000*1000B,而windows系统是按1MB=1024KB来计算的,这样以来标称256MB的内存在windows下显示的容量就应该为500*1000*1000*1000/1024/1024/1024=465.6612873077392578125

来看一看卡当你按了Power后--开机后磁盘的运行过程：
从打开电源到开始操作，计算机的启动是一个非常复杂的过程。，参考文章[计算机是如何启动的？](http://www.ruanyifeng.com/blog/2013/02/booting.html)
那我们看一看磁盘的运行过程：
![innerdisk](/image/innerdisk.png)
磁头在开始的时候放在起停区，磁头并不直接接触盘面。传动手臂来回摆动到盘面上来读取数据。详细参考文章[硬盘工作原理](http://www.doc88.com/p-078194549983.html)

##关于格式化你知道吗##
* 低级格式化：是将空白的磁盘划分出柱面和磁道，再将磁道划分为若干个扇区。
* 高级格式化：创建未来操作系统给使用的文件系统。

##磁盘结构##
![disk-structure](/image/disk-structure.png)
磁道、柱面、扇区
![disk2](/image/disk2.png)
早期的硬盘盘片的盘面以圆心开始向外放射状将磁道分割成等分的弧段，这些弧段便是硬盘的扇区(如图)。每个扇区一般规定大小为512byte，这里大家应该和我一样比较疑惑，外圈周长很明显比内圈要长，怎么可能每个扇区都是512byte?其实答案早期硬盘外圈存储比内圈存储密度低一些，所以外圈很长但是仍然只能存储512byte，因此如果我们知道了柱面数(磁道数)Cylinders、磁头数Heads、扇区数Sectors，基本上硬盘的容量我们能够计算出来 硬盘总容量= Cylinders * Heads * Sectors * 512byte。 但是由于早期硬盘外圈密度低，导致盘片利用率不高，现在的硬盘盘片则采用内外存储密度一致的方式，每个磁道都划分成以512byte大小的弧段，这样也造成了内外磁道上扇区数量会不一样，外圈上的扇区数要多于内圈扇区数。

* 需要注意的是
	* 0扇区的重要意思：第0面的第一个扇区。BIOS启动后，读取硬盘第一个扇区MBR中的引导加载程序。
	* 角速度相同，线速度不同产生的影响
	* 柱面（Cylinder）、磁头（Header）、扇区（Sector）三者简称CHS。通过这个就可以准确定位磁盘上的数据。
		* CHS（Cylinder/Head/Sector）寻址模式也称为3D模式，是硬盘最早采用的寻址模式，它是在硬盘容量较小的前提下产生的。硬盘的C/H/S 3D参数既可以计算出硬盘的容量，也可以确定数据所在的具体位置。这是因为扇区的三维物理地址与硬盘上的物理扇区一一对应，即三维物理地址可完全确定硬盘上的物理扇区。三维物理地址通常以C/H/S的次序来书写，如C/H/S为0/1/1，则第一个数字0指0柱面，第二个数字1指1磁头（盘面），第三个数字1指1扇区，表示该数据位于硬盘1盘面上的0磁道1扇区。现在定位已完成，硬盘内部的参数和主板BIOS之间进行协议，正确发出寻址信号，从而正确定位数据位置。
		* 早期硬盘一个磁道上分63个扇区，物理磁头最多16个（8个盘片，盘片多了硬盘那就真要加厚了）。采用8位寻址方式，8位二进制位的最大值是256（0-255），可以表示磁头数，而扇区只有63个（1-63），只需要其中6个二进制位即可表示，剩下2位拿去表示柱面，柱面数用10(8+2)位来表达，达到1024个柱面（0-1023），因此总扇区数（1024×16×63）。前面说一个扇区大小为512byte，这也就是说，如果以C/H/S寻址模式寻址，则IDE硬盘的最大容量只能为1024×16×63×512B= 500MB左右。
		* 可以思考下，在8位寻址模式下，其实可以寻址的硬盘最大容量为1024×256×63×512B =8G,那为啥CHS模式硬盘只支持到500MB呢？原因很简单，我们的硬盘盘片不可能让128片盘片重叠起来吧，那会是多厚？？如果采用28位寻址方式，那么可以寻址137G，盘片也不可能一直堆叠下去。
	* LBA方式
		* LBA(Logical Block Addressing)经常去买硬盘的人都知道，目前硬盘经常都说单碟、双碟，其实意思就是说硬盘盘片只有1个或者2个，而且都只是用一面，单碟一个磁头而已，但是硬盘容量确是几百G，而且硬盘柱面往往都大于1024个柱面，CHS是无法寻址利用完这些硬盘容量的。另外由于老硬盘的扇区划分方式对硬盘利用率不高，因此出现了现在的等密度盘，外圈的扇区数要比内圈多，原来的3D寻址方式也就不能适应这种方式，因此也就出现了新的寻址方式LBA，这是以扇区为单位进行的线性寻址方式，即从最外圈柱面0开始，依次将扇区号编为0、1…等等，举个例子，假设硬盘有1024个柱面，由于是等密度硬盘，柱面0(最外圈)假设有128个扇区，依次编号为0-127，柱面1有120个扇区，则依次编号为127-246，…依次最内圈柱面127只有扇区64个，则编号到最后。因此要定位到硬盘某个位置，只需要给出LBA数即可，这个就是逻辑数。
		* 在 LBA 模式下，为了保留原来CHS时的概念，也可以设置柱面、磁头、扇区等参数，但是他们并不是实际硬盘的物理参数，只是为了计算方便而出的一个概念，1023之前的柱面号都一一物理对应，而1023以后的所有柱面号都记录成1023磁头最大数可以设置为255，而扇区数一般是每磁道63个，硬盘控制器会把由柱面、磁头、扇区等参数确定的地址转换为LBA数。

##影响磁盘性能的4个因素##
* 转速：当读写数据时，磁头是不会动的，全靠盘片的转动来讲对应删去中的数据感应给磁头，所以磁盘的转速越快，数据传输的时间久越短，也就是我们说的速度传输快。不过增加转速会提高产品热量，同时噪声也会成倍增长，所以7200转到现在依然是绝对主流。
* 寻道速度:其实寻道时间就是磁头到达目标数据所在磁道的平均时间，影响性能最关键的因素。（固态硬盘没有寻道速度，所以快一些）[计算机磁盘寻道演示视频](http://v.ku6.com/show/F28kplfMQUKA_7H3.html)
* 数据密度（容量）：数据密度越大，在相同的转速和寻道速度条件下，具有高数据密度的硬盘会显示出更高的性能。
* 接口协议和速度：接口速度是影响硬盘性能的一个最不重要的因素。目前的接口速度在理论上都已经满足了磁盘所能达到的最高外部传输带宽。在随机IO环境下，接口速度显得更加不重要，因为此时的瓶颈几乎全部都在寻道速度上。不过，高端硬盘都用高速接口。
	* ATA和SCSI
	* IDE SATA

* 几个名词的理解
	* 顺序IO
	* 随机IO
	* IOPS：IOPS (Input/Output Operations Per Second)，即每秒进行读写（I/O）操作的次数，多用于数据库等场合，衡量随机访问的性能。
	* DMA模式：DMA(Direct Memory Access，直接内存存取) 是一种不经过CPU而直接从内存存取数据的数据交换模式。在DMA模式下，CPU只须向DMA控制器下达指令，让DMA控制器来处理数据的传送，数据传送完毕再把信息反馈给CPU，这样就很大程度上减轻了CPU资源占有率，可以大大节省系统资源。
	![dma](/image/dma.png)

##操作系统如何看待磁盘##
* 操作系统系统在保证性能和效率的情况下，进行上下层面的沟通、组织、协调。
* 对上，通过格式化，创建文件系统，上层应用程序对文件系统进行操作，达到进一步的封装。
* 对下，通过磁盘驱动程序直接操作磁盘，为上层提供安全、可靠的数据。

##Linux IO调度算法解析##
* 在资源充足情况下，写是很快的。
* 写的多种方式
* IO调度器的原则是尽量让磁头能够总是往一个方向移动，移动到底了再往反方向走。这恰恰就是现实生活中的电梯模型，所以IO调度器也被叫做电梯(elevator)，而相应的算法也就被叫做电梯算法。
* 查看当前系统支持的IO调度算法 `dmesg | grep -i scheduler`
* 查看当前系统正在使用的IO调度算法 `cat /sys/block/sda/queue/scheduler`

一篇比较好的文章[linux的IO调度算法和回写机制](http://www.cnblogs.com/zhenjing/archive/2012/06/20/linux_writeback.html)

##监控磁盘##
iostat 解析


#课后作业#
<b>1、DMA模式的具体含义是什么？</b>
* DMA模式：DMA(Direct Memory Access，直接内存存取) 是一种不经过CPU而直接从内存存取数据的数据交换模式。在DMA模式下，CPU只须向DMA控制器下达指令，让DMA控制器来处理数据的传送，数据传送完毕再把信息反馈给CPU，这样就很大程度上减轻了CPU资源占有率，可以大大节省系统资源。
![dma](/image/dma.png)


<b>2、低级格式化和高级格式化的各自含义是什么？</b>
* 低级格式化：是将空白的磁盘划分出柱面和磁道，再将磁道划分为若干个扇区。
* 高级格式化：创建未来操作系统给使用的文件系统。

<b>3、Linux IO调度算法都有哪些？各自的含义又是什么？</b>
* “Noop”算法
最简单的 I/O调度算法。该算法仅适当合并用户请求，并不排序请求：新的请求通常被插在调度队列的开头或末尾，下一个要处理的请求总是队列中的第一个请求。这种算法是为不需要寻道的块设备设计的，如SSD。
* “CFQ”算法
"CFQ（完全公平队列）”算法的主要目标是在触发I/O请求的所有进程中确保磁盘I/O带宽的公平分配。为了达到这个目标，算法使用许多个排序队列——缺省为64——它们存放了不同进程发出的请求。当算法处理一个请求时，内核调用一个散列函数将当前进程的线程组标识符(PID)；然后，算法将一个新的请求插人该队列的末尾。因此，同一个进程发出的请求通常被插入相同的队列中。
* “最后期限”算法
除了调度队列外，“最后期限”算法还使用了四个队列。其中的两个排序队列分别包含读请求和写请求，其中的请求是根据起始扇区号排序的。另外两个最后期限队列包含相同的读和写请求，但这是根据它们的“最后期限”排序的。引人这些队列是为了避免请求饿死，由于电梯策略(曾经的调度算法)优先处理与上一个所处理的请求最近的请求，因而就会对某个请求忽略很长一段时间，这时就会发生这种情况。请求的最后期限本质上就是一个超时定时器，当请求被传给电梯算法时开始计时。缺省情况下，读请求的超时时间是500ms，写请求的超时时间是5s——读请求优先于写请求，因为读请求通常阻塞发出请求的进程。最后期限保证了调度程序照顾等待很长一段时间的那个请求，即使它位于排序队列的末尾。
当算法要补充调度队列时，首先确定下一个请求的数据方向。如果同时要调度读和写两个请求，算法会选择“读”方向，除非该“写”方向已经被放弃很多次了（为了避免写请求饿死）。
接下来，算法检查与被选择方向相关的最后期限队列：如果队列中的第一个请求的最后期限已用完，那么算法将该请求移到调度队列的末尾。同时，它也会移动该过期的请求后面的一组来自排序队列的相同扇区号的请求。如果将要移动的请求在磁盘上物理相邻，那么这一批队列的长度会很长，否则就很短。
最后，如果没有请求超时，算法对来自于排序队列的最后一个请求连带之后的一组相同扇区的请求进行调度。当指针到达排序队列的末尾时，搜索又从头开始（“单方向算法”）。

* “预期”算法
“预期”算法是Linux提供的最复杂的一种1/O调度算法。基本上，它是“最后期限”算法的一个演变，借用了“最后期限”算法的基本机制：两个最后期限队列和两个排序队列；I/O调度程序在读和写请求之间交互扫描排序队列，不过更倾向于读请求。扫描基本上是连续的，除非有某个请求超时。读请求的缺省超时时间是125ms，写请求的缺省超时时间是250ms。但是，该算法还遵循一些附加的启发式准则：
	* 有些情况下，算法可能在排序队列当前位置之后选择一个请求，从而强制磁头从后搜索。这种情况通常发生在这个请求之后的搜索距离小于在排序队列当前位置之后对该请求搜索距离的一半时。
	算法统计系统中每个进程触发的I/O操作的种类。当刚刚调度了由某个进程p发出的一个读请求之后，算法马上检查排序队列中的下一个请求是否来自同一个进程p。如果是，立即调度下一个请求。否则，查看关于该进程p的统计信息：如果确定进程p可能很快发出另一个读请求，那么就延迟一小段时间（缺省大约为7ms）。因此，算法预测进程p发出的读请求与刚被调度的请求在磁盘上可能是“近邻”。
来自文章[linux的IO调度算法和回写机制](http://www.cnblogs.com/zhenjing/archive/2012/06/20/linux_writeback.html)	

<b>4、影响磁盘性能的因素都有哪些？各自的含义又是什么？</b>
* 转速：当读写数据时，磁头是不会动的，全靠盘片的转动来讲对应删去中的数据感应给磁头，所以磁盘的转速越快，数据传输的时间久越短，也就是我们说的速度传输快。不过增加转速会提高产品热量，同时噪声也会成倍增长，所以7200转到现在依然是绝对主流。
* 寻道速度:其实寻道时间就是磁头到达目标数据所在磁道的平均时间，影响性能最关键的因素。（固态硬盘没有寻道速度，所以快一些）[计算机磁盘寻道演示视频](http://v.ku6.com/show/F28kplfMQUKA_7H3.html)
* 数据密度（容量）：数据密度越大，在相同的转速和寻道速度条件下，具有高数据密度的硬盘会显示出更高的性能。
* 接口协议和速度：接口速度是影响硬盘性能的一个最不重要的因素。目前的接口速度在理论上都已经满足了磁盘所能达到的最高外部传输带宽。在随机IO环境下，接口速度显得更加不重要，因为此时的瓶颈几乎全部都在寻道速度上。不过，高端硬盘都用高速接口。
	* ATA和SCSI
	* IDE SATA


扩展阅读：
[MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)
结合索引涉及到了磁盘的一点原理。

---------------

学习的课程来自[炼数成金](http://www.dataguru.cn/)广州八神王磊老师的软件性能测试（第二期）^_^